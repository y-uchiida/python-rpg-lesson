# 開発パート06: ラスボスダンジョン機能を追加する

ここでは、ラスボスと戦うことができるダンジョンを実装していきます。  
通常のフィールドとは異なり、敵キャラクターのリストの最後にラスボスを1体追加することで、最後の1戦をラスボスとの戦いになるようにし実装します。  

また、すぐにラスボスダンジョンに行けるようになるのはゲームとして不十分なので、「複数回の戦闘勝利後にラスボスダンジョンへ行くことが選択できるようになる」という機能を作っていきます。

このパートで追加すべき機能は、以下の通りです。

1. 戦闘をクリアした回数のカウントを実装する
2. 戦闘クリア回数を増加させる機能を作成する
3. 通常の戦闘とラスボスダンジョンのクラスを分け、コンストラクタを作成する
4. 戦闘クリア回数が一定以上に達している場合に、ラスボスダンジョンを選択できるようにする
5. ラスボスダンジョンを選択して戦闘をクリアした場合、エンディングを迎える

## 1. 戦闘をクリアした回数のカウントを実装する

まずは、戦闘をクリアした回数を管理する変数を作成していきます。  
フィールドの敵キャラクターを全滅させたら、1回クリアとカウントすることにします。ゲームのステージを突破し、冒険を進めたというイメージです。
戦闘のクリア回数は、特定のField オブジェクトに依存するのではなく、ゲーム全体を通して利用される値です。  
そのため、Field オブジェクトとは切り離して、別の変数として管理することにします。
`main.py` の中に、戦闘クリア回数を管理する変数を作成します。

## 2. クリア回数を増加させる機能を作成する

つぎに、クリア回数を増加させる機能を追加します。`main.py` に作成した戦闘回数を増加させるメンバメソッドを作成しましょう。  
また、クリア回数が一定に達した際に、ラスボスダンジョンへ行けるようになったことを通知するメッセージを表示するとなおよいです。  

そして、戦闘勝利時の動作に、戦闘クリア回数を増やす処理を追加してください。  

## 3. 通常の戦闘とラスボスダンジョンのクラスを分け、コンストラクタを作成する

ラスボスダンジョンを表現するために、Field クラスのサブクラスとして、ラスボスダンジョンのクラスを作成しましょう。
このサブクラスのコンストラクタでは、敵キャラ一覧のlist の末尾に、ラスボスを追加するようにします。

## 4. 戦闘クリア回数が一定に達している場合に、ラスボスダンジョンを選択できるようにする

戦闘クリア後のコマンド選択（パート02 で作成した、次の戦闘を行うか、休憩するかを選択する部分）で、次の戦闘に行く選択をした後の処理を改修します。  
戦闘クリア回数が一定未満の場合は通常戦闘のみ選択できるようにし、一定以上の場合はラスボスダンジョンにも行けるようにします。  

## 5. ラスボスダンジョンを選択して戦闘をクリアした場合、エンディングを迎える

戦闘クリア時の処理に、クリアしたField オブジェクトがラスボスダンジョンだったかどうかを判定する処理を追加します。
ラスボスダンジョンをクリアした場合、エンディングのメッセージを終了するようにしましょう。

:::info
あるオブジェクトが特定のクラスを継承しているかどうかを判定するには、`type()` 関数, `isinstance()` 関数などが使えます。
:::

## 6. 動作の確認

ラスボスダンジョンへ移動できるようになったら、動作に問題がないかを確かめていきます。
すくなくとも、以下のパターンでエラーが起こらないことを確認してください。

:white_check_mark: 戦闘クリア時に、毎回ラスボスダンジョンへ行けるようになったメッセージが表示されてしまわないか  
:white_check_mark: 戦闘から逃げた場合に、戦闘クリア回数が増加していないか  
:white_check_mark: 通常の戦闘をクリアした際にも、エンディングメッセージが表示されてしまわないか  

## 7. 余裕のある人向けの追加ミッション　ソースコードのリファクタリング

作成したプログラムの動作を変えないように、記述内容をわかりやすく書き直したり、処理効率を高めたりすることをリファクタリングといいます。  
新しい機能を追加する場合などに、既存のコードの一部も修正してよりよい内容に改善できないか考える習慣をつけられるとよいです。  

パート06 まで進めてくると設定すべき変数や条件分岐が増えてきて、`main.py` の内容がかなり長くなってきていると思います。

このタイミングで、プログラム全体を見直してみて、修正できそうな部分がないかを確認してみてください。  

:::info
mainの処理や `battle()` 関数が長くなってしまうのは、たくさんのオブジェクトに対する処理（条件分岐や状態変更など）を記載しているためです。  
あるオブジェクトやクラス変数の値を操作している部分について、「そのオブジェクトのメソッドとして処理をまとめることができないか」を考えてみるようにしましょう。  
オブジェクトのメソッドとしてその処理を記述できれば、各オブジェクトのメソッドを呼び出すだけで済むようになります。
:::
